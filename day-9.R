library(dplyr)
library(bit64)


EXIT_OK <- 0
NEED_INPUT <- 1
NEED_ITER <- 2

operators <- list(
  "1" = list(fn = function(x) x[1] + x[2], args = 3, write.to.input = TRUE, do.jump = FALSE)
  , "2" = list(fn = function(x) x[1] * x[2], args = 3, write.to.input = TRUE, do.jump = FALSE)
  , "3" = list(fn = function(x){ x }, args = 1, input.args = TRUE, write.to.input = TRUE, do.jump = FALSE)
  , "4" = list(fn = function(x) {message("Output = ", x); x}, do.output = TRUE, args = 1, write.to.input = FALSE, do.jump = FALSE)
  , "5" = list(fn = function(x){
    if(as.logical(x[1])) return(x[2])
    return(NA)
  }, args = 2, write.to.input = FALSE, do.jump = TRUE)
  , "6" = list(fn = function(x){
    if(!as.logical(x[1])) return(x[2])
    return(NA)
  }, args = 2, write.to.input = FALSE, do.jump = TRUE)
  , "7" = list(fn = function(x){ as.numeric(x[1] < x[2]) }, args = 3, write.to.input = TRUE, do.jump = FALSE)
  , "8" = list(fn = function(x){ as.numeric(x[1] == x[2]) }, args = 3, write.to.input = TRUE, do.jump = FALSE)
  , "9" = list(fn = function(x){ x }, args = 1, write.to.input = FALSE, do.jump = FALSE, change.base = TRUE)
)

readArgument <- function(arg, mode, base, program){
  if(mode == 1) {
    rv <- as.integer64(arg)
  }
  else {
    if(mode == 0)
      index <- as.integer(arg) + 1L
    else
      index <- as.integer(arg) + 1L + base
    if (index > length(program))
      rv <- as.integer64(0L)
    else
      rv <- program[index]
  }
  # message("readArgument(", arg, ",", mode, ",", base, ",c(", paste(program, collapse = ","), ")) = ", as.numeric(rv))
  rv
}

computerDay9 <- function(program, offset = 0, input = c(0), output.result = NULL, base = 0) {
  # message("Offset = ", offset, "; base = ", base, "; Input = ", paste(program, collapse = ","))
  op.index.mode <- strsplit(as.character(program[offset + 1]), "")[[1]]
  # message("op.index.mode = ", paste(op.index.mode, collapse = ","))
  op.index <- paste(tail(op.index.mode, 2), collapse = "") %>% as.numeric() %>% as.character()
  if(op.index == "99") {
    message("Index is 99, quitting")
    return(list(program = program, status = EXIT_OK, output = output.result, input = input, offset = 0))
  }
  op.spec <- operators[[op.index]]
  op.modes <- numeric()
  if(length(op.index.mode) > 2)
    op.modes <- op.index.mode[1:(length(op.index.mode) - 2)] %>% rev %>% as.numeric()
  # message("args = ", op.spec$args, "; len(op.modes) = ", length(op.modes))
  op.modes <- c(op.modes, rep(0, op.spec$args - length(op.modes)))
  op.args <- as.numeric(program[(offset + 2) : (offset + 1 + op.spec$args)])
  # message(
  #   "op.index = ", op.index, "; op.spec = ", list(op.spec)
  #   , "; op.args = ", paste(op.args, collapse = ",")
  #   , "; op.modes = ", paste(op.modes, collapse = ",")
  # )
  all.args <- integer64()
  num.fn.args <- ifelse(op.spec$write.to.input, op.spec$args - 1, op.spec$args)
  # message("num args = ", num.fn.args)
  if(num.fn.args > 0) {
    for(i in 1:num.fn.args) {
      all.args <- c(all.args, readArgument(op.args[i], op.modes[i], base, program))
    }
  }
  if(!is.null(op.spec$input.args)){
    if(op.spec$input.args){
      if(length(input) == 0) {
        message("Input args required, but not present, quitting")
        return(list(status = NEED_INPUT, output = output.result, program = program, input = input, offset = offset))
      }
      message("Use input ", input[1])
      all.args <- c(all.args, as.integer64(input[1]))
      input <- tail(input, length(input) - 1)
    }
  }
  # message(
  #   "all.args = ", paste(all.args, collapse = ","), " op.args = ", paste(op.args, collapse = ",")
  #   , " op.modes = ", paste(op.modes, collapse = ","), " offset = ", offset, " base = ", base
  #   , " op.index.mode = ", op.index.mode
  # )
  result <- op.spec$fn(all.args)
  # message("Result: ", list(op.spec$fn), "(", paste(all.args, collapse = ","), ") = ", as.numeric(result))
  if(op.spec$write.to.input){
    if(length(program) < tail(op.args, 1) + 1)
      program <- c(program, rep(as.integer64(0), tail(op.args, 1) + 1 - length(program)))
    index <- tail(op.args, 1)
    if(tail(op.modes, 1) == 2)
      index <- index + base
    # message("Write ", result, " to program[", index + 1, "]")
    program[index + 1] <- as.integer64(result)
    # message(paste(program, collapse = ","))
  }
  if(op.spec$do.jump && !is.na(result))
    new.offset <- as.integer(result)
  else
    new.offset <- offset + op.spec$args + 1
  if(!is.null(op.spec$do.output)) {
    # message("Output 1")
    if(op.spec$do.output){
      # message("Output 2")
      output.result <- c(output.result, as.numeric(result))
    }
  }
  if(!is.null(op.spec$change.base)){
    if(op.spec$change.base){
      base <- base + as.integer(result)
      # message("New base = ", base)
    }
  }
  # message("New offset = ", new.offset)
  # return(list(status = NEED_INPUT, output = output.result, program = program, input = input, offset = offset))
  # if(all(program < 1e16))
  # computerDay9(program, new.offset, input, output.result, base)
  return(list(status = NEED_ITER, output = output.result, program = program, input = input, offset = new.offset, base = base))
}


computerDay9(as.integer64(c(
  109,1,204,-1,1001,100,1,100,1008,100,16,101,1006,101,0,99
)))
computerDay9(as.integer64(c(
  1102,34915192,34915192,7,4,7,99,0
)))
computerDay9(as.integer64(c(
  104,1125899906842624,99
)))
computerDay9(as.integer64(c(
  3,9,8,9,10,9,4,9,99,-1,8
)), input = 16)
computerDay9(as.integer64(c(3,225,1,225,6,6,1100,1,238,225,104,0,1101,78,5,225,1,166,139,224,101,-74,224,224,4,224,1002,223,8,223,1001,224,6,224,1,223,224,223,1002,136,18,224,101,-918,224,224,4,224,1002,223,8,223,101,2,224,224,1,224,223,223,1001,83,84,224,1001,224,-139,224,4,224,102,8,223,223,101,3,224,224,1,224,223,223,1102,55,20,225,1101,53,94,225,2,217,87,224,1001,224,-2120,224,4,224,1002,223,8,223,1001,224,1,224,1,224,223,223,102,37,14,224,101,-185,224,224,4,224,1002,223,8,223,1001,224,1,224,1,224,223,223,1101,8,51,225,1102,46,15,225,1102,88,87,224,1001,224,-7656,224,4,224,102,8,223,223,101,7,224,224,1,223,224,223,1101,29,28,225,1101,58,43,224,1001,224,-101,224,4,224,1002,223,8,223,1001,224,6,224,1,224,223,223,1101,93,54,225,101,40,191,224,1001,224,-133,224,4,224,102,8,223,223,101,3,224,224,1,223,224,223,1101,40,79,225,4,223,99,0,0,0,677,0,0,0,0,0,0,0,0,0,0,0,1105,0,99999,1105,227,247,1105,1,99999,1005,227,99999,1005,0,256,1105,1,99999,1106,227,99999,1106,0,265,1105,1,99999,1006,0,99999,1006,227,274,1105,1,99999,1105,1,280,1105,1,99999,1,225,225,225,1101,294,0,0,105,1,0,1105,1,99999,1106,0,300,1105,1,99999,1,225,225,225,1101,314,0,0,106,0,0,1105,1,99999,1008,226,677,224,1002,223,2,223,1005,224,329,1001,223,1,223,1107,226,677,224,1002,223,2,223,1005,224,344,1001,223,1,223,8,677,226,224,1002,223,2,223,1006,224,359,1001,223,1,223,1108,226,677,224,1002,223,2,223,1006,224,374,101,1,223,223,1007,677,677,224,102,2,223,223,1006,224,389,1001,223,1,223,8,226,677,224,102,2,223,223,1006,224,404,101,1,223,223,1007,226,226,224,1002,223,2,223,1006,224,419,101,1,223,223,107,677,226,224,1002,223,2,223,1006,224,434,1001,223,1,223,1007,226,677,224,102,2,223,223,1005,224,449,101,1,223,223,1107,226,226,224,1002,223,2,223,1005,224,464,1001,223,1,223,107,226,226,224,102,2,223,223,1006,224,479,101,1,223,223,108,226,226,224,1002,223,2,223,1006,224,494,101,1,223,223,107,677,677,224,102,2,223,223,1005,224,509,1001,223,1,223,1008,677,677,224,1002,223,2,223,1006,224,524,101,1,223,223,1107,677,226,224,102,2,223,223,1006,224,539,1001,223,1,223,108,677,226,224,102,2,223,223,1006,224,554,1001,223,1,223,1108,677,226,224,102,2,223,223,1005,224,569,1001,223,1,223,8,677,677,224,1002,223,2,223,1005,224,584,1001,223,1,223,7,677,677,224,1002,223,2,223,1005,224,599,101,1,223,223,1108,226,226,224,102,2,223,223,1006,224,614,101,1,223,223,1008,226,226,224,1002,223,2,223,1005,224,629,101,1,223,223,7,677,226,224,102,2,223,223,1006,224,644,1001,223,1,223,7,226,677,224,102,2,223,223,1005,224,659,101,1,223,223,108,677,677,224,1002,223,2,223,1006,224,674,101,1,223,223,4,223,99,226))
             , input = 5)
computerDay9(as.integer64(c(
  104,1125899906842624,99
)))

computerDay9(c(3,9,8,9,10,9,4,9,99,-1,8), input = 8)
computerDay9(c(3,9,8,9,10,9,4,9,99,-1,8), input = 8)

start <- computerDay9(as.integer64(c(
  1102,34463338,34463338,63,1007,63,34463338,63,1005,63,53,1102,3,1,1000,109,988,209,12,9,1000,209,6,209,3,203,0,1008,1000,1,63,1005,63,65,1008,1000,2,63,1005,63,904,1008,1000,0,63,1005,63,58,4,25,104,0,99,4,0,104,0,99,4,17,104,0,99,0,0,1101,20,0,1007,1101,0,197,1022,1102,475,1,1028,1102,30,1,1008,1101,25,0,1010,1102,1,23,1009,1101,0,22,1013,1101,470,0,1029,1102,24,1,1014,1102,1,39,1005,1101,31,0,1003,1101,807,0,1026,1101,0,26,1018,1102,1,804,1027,1101,0,0,1020,1102,1,38,1017,1101,0,27,1016,1102,443,1,1024,1101,0,36,1006,1102,21,1,1015,1101,28,0,1001,1102,33,1,1019,1102,1,37,1011,1102,1,190,1023,1101,0,434,1025,1101,34,0,1004,1102,1,1,1021,1101,0,29,1012,1102,1,32,1002,1101,35,0,1000,109,30,2105,1,-7,1001,64,1,64,1105,1,199,4,187,1002,64,2,64,109,-23,2101,0,-5,63,1008,63,32,63,1005,63,225,4,205,1001,64,1,64,1105,1,225,1002,64,2,64,109,7,2102,1,-5,63,1008,63,23,63,1005,63,251,4,231,1001,64,1,64,1106,0,251,1002,64,2,64,109,-16,2101,0,2,63,1008,63,33,63,1005,63,275,1001,64,1,64,1106,0,277,4,257,1002,64,2,64,109,10,21102,40,1,4,1008,1012,40,63,1005,63,299,4,283,1106,0,303,1001,64,1,64,1002,64,2,64,109,7,2102,1,-9,63,1008,63,33,63,1005,63,327,1001,64,1,64,1105,1,329,4,309,1002,64,2,64,109,-17,2107,34,2,63,1005,63,347,4,335,1105,1,351,1001,64,1,64,1002,64,2,64,109,1,1201,8,0,63,1008,63,23,63,1005,63,375,1001,64,1,64,1106,0,377,4,357,1002,64,2,64,109,-4,2108,31,8,63,1005,63,395,4,383,1105,1,399,1001,64,1,64,1002,64,2,64,109,3,1201,8,0,63,1008,63,36,63,1005,63,421,4,405,1105,1,425,1001,64,1,64,1002,64,2,64,109,25,2105,1,1,4,431,1001,64,1,64,1105,1,443,1002,64,2,64,109,-3,1205,0,459,1001,64,1,64,1106,0,461,4,449,1002,64,2,64,109,-2,2106,0,10,4,467,1106,0,479,1001,64,1,64,1002,64,2,64,109,12,1206,-9,495,1001,64,1,64,1106,0,497,4,485,1002,64,2,64,109,-39,1207,9,36,63,1005,63,519,4,503,1001,64,1,64,1105,1,519,1002,64,2,64,109,11,1202,-1,1,63,1008,63,28,63,1005,63,541,4,525,1105,1,545,1001,64,1,64,1002,64,2,64,109,6,2107,24,1,63,1005,63,565,1001,64,1,64,1106,0,567,4,551,1002,64,2,64,109,1,1207,-3,35,63,1005,63,583,1106,0,589,4,573,1001,64,1,64,1002,64,2,64,109,1,21102,41,1,5,1008,1015,40,63,1005,63,613,1001,64,1,64,1105,1,615,4,595,1002,64,2,64,109,-2,2108,22,1,63,1005,63,635,1001,64,1,64,1105,1,637,4,621,1002,64,2,64,109,-10,1208,4,33,63,1005,63,653,1106,0,659,4,643,1001,64,1,64,1002,64,2,64,109,16,1206,6,673,4,665,1106,0,677,1001,64,1,64,1002,64,2,64,109,-4,1202,-8,1,63,1008,63,35,63,1005,63,701,1001,64,1,64,1105,1,703,4,683,1002,64,2,64,109,13,21108,42,42,-8,1005,1015,721,4,709,1105,1,725,1001,64,1,64,1002,64,2,64,109,-18,21107,43,44,5,1005,1010,743,4,731,1106,0,747,1001,64,1,64,1002,64,2,64,109,-11,1208,8,32,63,1005,63,765,4,753,1106,0,769,1001,64,1,64,1002,64,2,64,109,15,21101,44,0,5,1008,1014,47,63,1005,63,789,1105,1,795,4,775,1001,64,1,64,1002,64,2,64,109,13,2106,0,5,1106,0,813,4,801,1001,64,1,64,1002,64,2,64,109,-12,21108,45,43,0,1005,1010,829,1106,0,835,4,819,1001,64,1,64,1002,64,2,64,109,-4,21107,46,45,10,1005,1016,855,1001,64,1,64,1106,0,857,4,841,1002,64,2,64,109,3,21101,47,0,5,1008,1014,47,63,1005,63,883,4,863,1001,64,1,64,1106,0,883,1002,64,2,64,109,10,1205,2,901,4,889,1001,64,1,64,1105,1,901,4,64,99,21102,27,1,1,21102,915,1,0,1106,0,922,21201,1,13433,1,204,1,99,109,3,1207,-2,3,63,1005,63,964,21201,-2,-1,1,21101,0,942,0,1106,0,922,22102,1,1,-1,21201,-2,-3,1,21102,1,957,0,1105,1,922,22201,1,-1,-2,1106,0,968,21202,-2,1,-2,109,-3,2106,0,0
)), input = 2)

i <- 1
while(start$status == NEED_ITER && length(start$output) == 0 && i < 1e9){
  start <- computerDay9(
    start$program
    , start$offset
    , start$input
    , start$output
    , start$base
  )
  i <- i + 1
}
